name: Test

on:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-ubuntu:
    name: Test Ubuntu
    runs-on: ubuntu-latest
    strategy:
      matrix:
        version: [2022.1, 2023.1]
        target: ["Android", "Linux"]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Wwise SDK
        uses: ./
        with:
          wwise-version: ${{ matrix.version }}

      - name: Create Test Project
        run: |
          python "$WWISEROOT/Scripts/Build/Plugins/wp.py" new --effect -n Test -t Test -a author -d desc --no-prompt

      - name: Build ${{ matrix.target }}
        working-directory: Test
        run: |
          python "$WWISEROOT/Scripts/Build/Plugins/wp.py" premake ${{ matrix.target }}
          python "$WWISEROOT/Scripts/Build/Plugins/wp.py" build ${{ matrix.target }} -c Debug
          python "$WWISEROOT/Scripts/Build/Plugins/wp.py" build ${{ matrix.target }} -c Profile
          python "$WWISEROOT/Scripts/Build/Plugins/wp.py" build ${{ matrix.target }} -c Release
          python "$WWISEROOT/Scripts/Build/Plugins/wp.py" package ${{ matrix.target }} -v 2000.0.0.0

  test-windows:
    name: Test Windows
    runs-on: windows-latest
    strategy:
      matrix:
        version: [2022.1, 2023.1]
        target: ["Authoring", "Windows_vc170"]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Wwise SDK
        uses: ./
        with:
          wwise-version: ${{ matrix.version }}

      - name: Create Test Project
        run: |
          python "$env:WWISEROOT\Scripts\Build\Plugins\wp.py" new --effect -n Test -t Test -a author -d desc --no-prompt

      - name: Build ${{ matrix.target }}
        working-directory: Test
        run: |
          python "$env:WWISEROOT\Scripts\Build\Plugins\wp.py" premake ${{ matrix.target }}
          python "$env:WWISEROOT\Scripts\Build\Plugins\wp.py" build ${{ matrix.target }} -c Debug -t vc170
          python "$env:WWISEROOT\Scripts\Build\Plugins\wp.py" build ${{ matrix.target }} -c Profile -t vc170
          python "$env:WWISEROOT\Scripts\Build\Plugins\wp.py" build ${{ matrix.target }} -c Release -t vc170
          python "$env:WWISEROOT\Scripts\Build\Plugins\wp.py" package ${{ matrix.target }} -v 2000.0.0.0

  test-macos:
    name: Test macOS
    runs-on: macos-latest
    strategy:
      matrix:
        version: [2022.1, 2023.1]
        target: ["iOS", "Mac"]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Wwise SDK
        uses: ./
        with:
          wwise-version: ${{ matrix.version }}

      - name: Create Test Project
        run: |
          python "$WWISEROOT/Scripts/Build/Plugins/wp.py" new --effect -n Test -t Test -a author -d desc --no-prompt

      - name: Build ${{ matrix.target }}
        working-directory: Test
        run: |
          python "$WWISEROOT/Scripts/Build/Plugins/wp.py" premake ${{ matrix.target }}
          python "$WWISEROOT/Scripts/Build/Plugins/wp.py" build ${{ matrix.target }} -c Debug
          python "$WWISEROOT/Scripts/Build/Plugins/wp.py" build ${{ matrix.target }} -c Profile
          python "$WWISEROOT/Scripts/Build/Plugins/wp.py" build ${{ matrix.target }} -c Release
          python "$WWISEROOT/Scripts/Build/Plugins/wp.py" package ${{ matrix.target }} -v 2000.0.0.0
